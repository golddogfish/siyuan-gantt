# 甘特图挂件

思源笔记的甘特图可视化挂件，用于从数据库视图展示项目时间线。

> 🤖 **本挂件完全由 AI 设计和开发。**
>
> 📦 **基于 [FullCalendar](https://fullcalendar.io/) 开源项目。**

## 功能特性

- ✅ 从思源数据库视图读取项目数据
- ✅ 周视图和月视图切换
- ✅ 今日标记线（红色）及日期表头高亮
- ✅ 周末背景高亮
- ✅ **拖拽调整项目时间，数据库自动同步**
- ✅ **右键点击甘特条直接修改状态，数据库自动同步**
- ✅ 状态颜色自定义
- ✅ 屏蔽指定状态
- ✅ 配置自动保存
- ✅ 状态列表过长时右键菜单支持滚动

## 系统要求

- **思源笔记**: v2.10.0 或更高版本（需要稳定的数据库 API 支持）

## 使用方法

### 1. 准备数据库

#### 方式一：使用本挂件提供的模板（最简单）

直接从仓库下载模板（支持中文 / 英文文件名），在思源笔记中导入即可使用：

- 中文模板：[`甘特图模板.sy.zip`](https://raw.githubusercontent.com/golddogfish/siyuan-gantt/main/%E7%94%98%E7%89%B9%E5%9B%BE%E6%A8%A1%E6%9D%BF.sy.zip)
- English template: [`Gantt Chart Template.sy.zip`](https://raw.githubusercontent.com/golddogfish/siyuan-gantt/main/Gantt%20Chart%20Template.sy.zip)

导入后可立即使用。

#### 方式二：使用推荐模板

本挂件也支持配合 [思源笔记项目管理数据库模板](https://ld246.com/article/1732722385803) 使用。

**重要提示**：使用该模板时，需要将第一个「状态」列重命名为「完成情况」，避免与第二个「状态」列重名，同时方便挂件正确读取数据。

#### 方式三：手动创建数据库

在思源笔记中创建一个数据库，包含以下列：

- **TODO/项目名称/项目内容/标题**：项目的名称
- **状态**：项目状态（单选类型）
- **开始日/开始时间/开始日期**：项目开始日期
- **截止日/截止时间/截止日期**：项目截止日期

> 💡 **列名识别说明**：挂件会自动识别以下列名
> - 项目名称列：`TODO`、`项目内容`、`项目名称`、`标题`、`headline`
> - 状态列：`状态`、`status`
> - 开始日期列：`开始日`、`开始时间`、`开始日期`、`start`
> - 截止日期列：`截止日`、`截止时间`、`截止日期`、`end`

### 2. 插入挂件

在思源笔记中插入挂件，选择"甘特图"。

### 3. 配置挂件

点击右上角的 ⚙️ 按钮：

1. **输入数据库ID**：输入你的数据库块ID
2. **选择屏蔽状态**：勾选不想显示的状态
3. **自定义颜色**：为每个状态选择颜色
4. 点击"保存并刷新"

### 4. 查看甘特图

- 使用工具栏切换周视图/月视图
- **拖拽色块调整项目时间**，数据库会自动同步更新
- **右键点击色块修改项目状态**，数据库会自动同步更新
- 滚动查看更多项目

> ⚠️ **同步提示**：如果发现数据未同步，请点击右上角 ⚙️ 按钮，然后点击「保存并刷新」按钮重新加载数据。

## 配置说明

挂件配置会自动保存在 `/data/widgets/siyuan-gantt/gantt-config-{挂件ID}.json` 文件中。

## 更新日志

### v1.4.0 (2025-12-28)

- ✨ **英语界面与稳定性改进**：新增英语界面支持，并增强工具栏与控件稳定性，防止宿主重新渲染时丢失事件处理器。
- 🔧 **修复**：使用 FullCalendar 的 API（`calendar.setOption`）并合并现有 `customButtons` 来保留点击处理器，消除了视图切换导致的工具栏重复/闪烁；新增事件委托回退与 MutationObserver 以在宿主重建工具栏时恢复交互。
- 📁 **配置迁移与备份**：升级时自动迁移并合并旧配置（如 `customColorMap` → `customColors`），并在覆盖写回前创建时间戳备份文件以便回滚。
- 🧪 **新增测试**：补充/新增 Puppeteer 测试覆盖本地化、工具栏导航瞬态检测与配置迁移验证等场景。
- 🔒 **默认设置**：默认仍关闭 DEBUG/性能剖析；需要时可通过 `TEST_DEBUG=1` 在测试时启用页面级调试日志。


### v1.3.4 (2025-12-18)

- ✅ 合并：v1.3.4（源自 v1.3.2 分支）已合并到 `main`，发布包存放于 `releases/v1.3.4/package.zip`。
- ⚡ 小幅修正：打包与文档更新，包含此前的性能与生产安全修复。

### v1.3.3 (2025-12-18)

- 🔒 **使用/开发模式分离**：默认在生产环境禁用 `DEBUG` 与 `DEBUG_PROFILING`，将调试日志与性能剖析工具与运行时功能分离，防止日志噪声和调试采样影响正常运行性能。
- ⚡ **性能**：减少无谓的 `console.log`（仅在 `DEBUG===true` 时输出），复用事件/资源对象，按视窗懒加载事件/资源，添加数字时间戳用于快速范围判断，整体降低短时分配与 GC 压力。
- 🔧 **采样工具说明**：`runProfile`、`scripts/offline_profile.js` 与离线生成的测试数据仍保留用于开发环境性能采样，但**默认在生产模式下不运行**；如需在本地开发启用，请在 DevTools 中设置 `window.DEBUG_PROFILING = true` 并手动运行 `window.runProfile({iterations:10, delay:200})`。
- ✅ **其他改进**：移除每事件独立的右键监听（改为委托），减少内存占用，并优化日志以降低开销。
- ⚠️ **生产性能安全**：在生产中关闭了某些基于 rAF 的即时操作（改用 setTimeout/requestIdleCallback 回退），以避免浏览器控制台出现“Forced reflow / requestAnimationFrame handler took …” 类的 DevTools 性能警告。

### v1.3.2 (2025-12-18)

- 🔧 **性能**：添加轻量级性能剖析助手与 `runProfile` 采样工具（默认处于禁用状态，需在开发环境中将 `DEBUG_PROFILING` 设为 `true` 并通过 devtools 手动启用进行采样）；替换日历的批量 remove/add 为 `calendar.setOption('resources', ...)` 和 `calendar.setOption('events', ...)`，以利用 FullCalendar 内部 diff 算法，显著提升大量事件场景下的渲染性能。
- 🔧 **内存**：取消每个事件的独立右键监听器，改为委托式处理并在 DOM 上设置 `data-event-id`（减少大量事件时的内存/GC 压力）。
- 🧪 新增 `scripts/offline_profile.js` 与 `scripts/generate_large_json.js`，用于重现并基准测试大数据集（已使用 10k 行完成测试）。


### v1.3.1 (2025-12-18)

- 🔖 保存：将当前工作版本存为 **v1.3.1**。
- ⚙️ 性能准备：添加 debug/profiling 标志并减少噪声日志，为 v1.3.2 的性能剖析与优化做准备。
- 🧾 文档与发布：更新了发布包和资产（已包含 icon/preview）。

### v1.3.0 (2025-12-17)

- ✨ 新增：支持**明亮主题（Light）**，并在每次刷新时同步 SiYuan 的明暗模式
- 🔧 改进：应用主题时会同时在 `html`/`body`/`#calendar` 上切换类，并触发 FullCalendar 布局刷新，增强样式生效的可靠性
- 🔧 修复：设置面板的控件在明亮主题下显示深色文字，输入框与复选框样式修复
- 🔧 修复：今日标记（下划线与指示线）在明亮主题下保持红色并不再被遮挡
- 🔧 改进：滚动同步逻辑更稳健（多选择器尝试、短期重试与 MutationObserver 一次性回退）

### v1.2.0 (2025-12-16)

- ✨ 新增：右键点击甘特条可直接修改状态
- ✨ 新增：今日日期表头底部红线高亮
- 🔧 修复：项目名称现在会正确移除末尾标签（如 `#1#`）
- 🔧 修复：日期范围显示现在覆盖完整的截止日
- 🔧 修复：状态列表过长时右键菜单可滚动
- 🎯 变更：拖拽限制为仅水平方向（不能切换行）
- 🎯 变更：隐藏今日指示线的小三角箭头

### v1.1.0 (2025-12-16)

- 🔧 修复：关闭窗口后数据库ID现在会正确保存和恢复
- 🎯 默认视图改为周视图
- 📍 打开月视图时自动将今天滚动到屏幕中央
- 🎨 更新默认配色方案（14种鲜艳颜色）
- ✨ 优化甘特条与左侧文字的垂直对齐
- 🔄 修复左右滚动同步问题
- ⚡ 优化滚动性能，减少视图切换时的卡顿

### v1.0.0 (2025-12-14)

- 初始版本发布
- 支持从数据库视图读取数据
- 支持周视图和月视图
- 支持状态颜色自定义
- 支持屏蔽指定状态

## 开发与测试

- 本地运行与测试（需 Node.js）：
  - `node scripts/test_locale.js` — 验证本地化（en/zh）
  - `node scripts/test_toolbar_navigation.js` — 验证在视图导航时工具栏不会出现重复或瞬态闪烁
  - `node scripts/test_name_parse.js` — 单元格名称解析测试
  - `node scripts/test_real_db.js` — 使用 `data/` 下的真实 AV JSON 做回归测试。
  - 说明：**默认不启用 DEBUG**；如果需要开启页面级调试日志，请在运行前设置环境变量 `TEST_DEBUG=1`。

- 在真实思源环境调试建议：
  1. 在 DevTools Console 中启用调试：`window.DEBUG = true`。
  2. 打开甘特图，切换周视图/月视图并反复点击左右箭头（prev/next）。
  3. 如果发现问题，收集工具栏 DOM 快照（运行 `document.querySelector('.fc-toolbar').outerHTML`）并将输出贴上来。

- 说明：
  - 本次工具栏重复问题的根本修复方式是使用 FullCalendar 的 API（`calendar.setOption`）替代直接的 DOM 文本覆盖，以避免与 FullCalendar 内部渲染产生竞态。
  - 本地测试使用 Puppeteer，不依赖外网。

### 配置迁移与备份

- 升级后：挂件在加载时会**自动迁移与合并**已保存的配置（不会因为升级而强制覆盖原有配置），会自动识别历史字段（例如 `customColorMap`）并转换为新版字段名。 
- 备份：在覆盖写回配置前会创建一个时间戳备份，路径示例：`/data/widgets/siyuan-gantt/gantt-config-<widgetId>.backup-<ts>.json`，便于回滚与排查。
- 验证：可通过运行 `node scripts/test_config_migration.js` 来模拟旧格式配置并验证是否被正确迁移与应用。

## 许可证

GPL-3.0 License

## 作者

goldfish
